!function(a){"use strict";var b=function(){},c=!("function"!=typeof define||!define.amd),d=3,e=function(){function a(a){this.prefix=a||"-",this.prefix="["+this.prefix+"]"}return a.prototype.trace=function(){d>=1&&console.debug("[TRACE]",this.prefix,Array.prototype.slice.call(arguments))},a.prototype.debug=function(){d>=2&&console.debug("[DEBUG]",this.prefix,Array.prototype.slice.call(arguments))},a.prototype.info=function(){d>=3&&console.info("[INFO ]",this.prefix,Array.prototype.slice.call(arguments))},a.prototype.warn=function(){d>=4&&console.warn("[WARN ]",this.prefix,Array.prototype.slice.call(arguments))},a.prototype.error=function(){d>=5&&console.error("[ERROR]",this.prefix,Array.prototype.slice.call(arguments))},a}(),f=function(){function b(){this.VERSION="0.6.3",this.LOOP_NOT=0,this.LOOP_ORIGINAL=1,this.LOOP_NATIVE=2,this.POWER_OFF=!1,this.POWER_ON=!0,this.ERROR_MEDIA_TYPE=0,this.ERROR_HIT_FILTER=1,this.setuped=!1,this.support={mimes:[],webaudio:{use:!!a.webkitAudioContext},htmlaudio:{use:!1},htmlvideo:{use:!1}},this.support.webaudio.use&&(this.WEB_AUDIO_CONTEXT=new a.webkitAudioContext,this.WEB_AUDIO_CONTEXT.createGain||(this.WEB_AUDIO_CONTEXT.createGain=this.WEB_AUDIO_CONTEXT.createGainNode));try{this._audio=new a.Audio,this.support.htmlaudio.use=this._audio.canPlayType?!0:!1}catch(b){this.support.htmlaudio.use=!1}try{this._video=document.createElement("video"),this.support.htmlvideo.use=this._video.canPlayType?!0:!1}catch(b){this.support.htmlvideo.use=!1}this.pool={},this.waits=[],this.visibility={hidden:void 0,visibilityChange:void 0},this.state={power:this.POWER_ON},this.filter={}}return b.prototype.isWebAudio=function(){return this.support.webaudio.use},b.prototype.isHTMLAudio=function(){return this.support.htmlaudio.use},b.prototype.isHTMLVideo=function(){return this.support.htmlvideo.use},b.prototype.isPlayback=function(){var a=!1;for(var b in this.pool)if(this.pool[b].isPlayback()){a=!0;break}return a},b.prototype.setup=function(a){return a=a||{},"undefined"!=typeof a.loglevel&&(d=a.loglevel),this.logger=new e("BoomBox "),this.setuped?(this.logger.warn('"setup" already, are running.'),this):(a=a||{},a.webaudio&&"undefined"!=typeof a.webaudio.use&&(this.support.webaudio.use=a.webaudio.use,this.logger.info("options.webaudio.use:",this.support.webaudio.use)),a.htmlaudio&&"undefined"!=typeof a.htmlaudio.use&&(this.support.htmlaudio.use=a.htmlaudio.use,this.logger.info("options.htmlaudio.use: ",this.support.htmlaudio.use)),a.htmlvideo&&"undefined"!=typeof a.htmlvideo.use&&(this.support.htmlvideo.use=a.htmlvideo.use,this.logger.info("options htmlvideo",this.support.htmlvideo)),this._browserControl(),this.logger.debug(this.support.webaudio.use?"WebAudio use support.":"WebAudio use not support."),this.logger.debug(this.support.htmlaudio.use?"HTMLAudio use support.":"HTMLAudio use not support."),this.logger.debug(this.support.htmlvideo.use?"HTMLVideo use support.":"HTMLVideo use not support."),this.setuped=!0,this)},b.prototype.get=function(a){return this.pool[a]},b.prototype.load=function(a,b,c,d){if("function"==typeof arguments[2]&&(d=c,c=null),!this.setuped)return d&&d(new Error("setup incomplete boombox. run: boombox.setup(options)")),this;if(this.pool[a])return this.logger.trace("audio pool cache hit!!",a),d&&d(null,this.pool[a]);var e=this.useMediaType(b.src);if(e&&(b.media=e.media,b.src=e.path),c&&this.isHTMLVideo()){var f=new g.HTMLVideo(a);return e||(f.state.error=this.ERROR_MEDIA_TYPE),"undefined"!=typeof f.state.error||this.runfilter(f,b)||f.load(b,d),this.setPool(a,f),this}if(this.isWebAudio()){this.logger.debug("use web audio");var h=new g.WebAudio(a);e||(h.state.error=this.ERROR_MEDIA_TYPE),"undefined"!=typeof h.state.error||this.runfilter(h,b)||h.load(b,d),this.setPool(a,h)}else if(this.isHTMLAudio()){this.logger.debug("use html audio");var i=new g.HTMLAudio(a);e||(i.state.error=this.ERROR_MEDIA_TYPE),"undefined"!=typeof i.state.error||this.runfilter(i,b)||i.load(b,d),this.setPool(a,i)}else d&&d(new Error("This environment does not support HTMLAudio, both WebAudio both."),this);return this},b.prototype.remove=function(a){return this.pool[a]&&(this.logger.trace("Remove Audio that is pooled. name",a),this.pool[a].dispose&&this.pool[a].dispose(),this.pool[a]=void 0,delete this.pool[a]),this},b.prototype.setPool=function(a,b){return this.remove(a),this.pool[a]=b,this.pool[a]},b.prototype.runfilter=function(a,b){for(var c,d=b.filter||[],e=0;e<d.length;e++){var f=d[e],g=this.filter[f];if(!g)return void this.logger.warn("filter not found. name:",f);if(this.logger.debug("filter run. name:",f),g(f,a,b)){c=f;break}}return c?(a.state.error=this.ERROR_HIT_FILTER,this.logger.warn("Hit the filter of",c),!0):!1},b.prototype.useMediaType=function(a){for(var b=0;b<a.length;b++){var c=a[b];if(this._audio.canPlayType(c.media))return c;this.logger.warn("skip audio type.",c.media)}return void 0},b.prototype.pause=function(){var a=this;this.logger.trace("pause");for(var b in this.pool){var c=this.pool[b];c.pause(),a.waits.push(b)}return this},b.prototype.resume=function(){this.logger.trace("resume");var a=this.waits.shift();return a&&this.pool[a]&&this.pool[a].resume(),0<this.waits.length&&this.resume(),this},b.prototype.power=function(a){this.logger.trace("change power",a);for(var b in this.pool){var c=this.pool[b];c.power(a)}return this.state.power=a,this},b.prototype.volume=function(a){this.logger.trace("volume");for(var b in this.pool){var c=this.pool[b];c.volume(a)}},b.prototype.onVisibilityChange=function(){this.logger.trace("onVisibilityChange"),document[this.visibility.hidden]?this.pause():this.resume()},b.prototype.onFocus=function(){this.logger.trace("onFocus"),this.resume()},b.prototype.onBlur=function(){this.logger.trace("onBlur"),this.pause()},b.prototype.onPageShow=function(){this.logger.trace("onPageShow"),this.resume()},b.prototype.onPageHide=function(){this.logger.trace("onPageHide"),this.pause()},b.prototype._browserControl=function(){var a=this;return"undefined"!=typeof document.hidden?(this.visibility.hidden="hidden",this.visibility.visibilityChange="visibilitychange"):"undefined"!=typeof document.webkitHidden?(this.visibility.hidden="webkitHidden",this.visibility.visibilityChange="webkitvisibilitychange"):"undefined"!=typeof document.mozHidden?(this.visibility.hidden="mozHidden",this.visibility.visibilityChange="mozvisibilitychange"):"undefined"!=typeof document.msHidden&&(this.visibility.hidden="msHidden",this.visibility.visibilityChange="msvisibilitychange"),this.visibility.hidden&&document.addEventListener(this.visibility.visibilityChange,function(b){a.onVisibilityChange(b)},!1),"undefined"!=typeof window.addEventListener?(window.addEventListener("focus",function(b){a.onFocus(b)},!1),window.addEventListener("blur",function(b){a.onBlur(b)},!1)):(window.attachEvent("onfocusin",function(b){a.onFocus(b)},!1),window.attachEvent("onfocusout",function(b){a.onBlur(b)},!1)),window.onpageshow=function(b){a.onPageShow(b)},window.onpagehide=function(b){a.onPageHide(b)},this},b.prototype.addFilter=function(a,b){this.filter[a]=b},b.prototype.dispose=function(){for(var a in this.pool){var b=this.pool[a];b.dispose&&b.dispose()}delete this.VERSION,delete this.setuped,delete this.support.mimes,delete this.support.webaudio.use,this.WEB_AUDIO_CONTEXT&&delete this.WEB_AUDIO_CONTEXT,delete this.support.webaudio,delete this.support.htmlaudio.use,delete this.support.htmlaudio,delete this.support.htmlvideo.use,delete this.support.htmlvideo,delete this.support,delete this.pool,delete this.waits,delete this.visibility,delete this.state.power,delete this.state,delete this._audio,delete this._video,delete this.filter},b}(),g=new f,h=function(){function c(b){this.logger=new e("HTMLAudio"),this.name=b,this.state={time:{playback:void 0,pause:void 0},loop:g.LOOP_NOT,power:g.POWER_ON,loaded:!1,error:void 0},this.$el=new a.Audio}return c.prototype.load=function(a,b){var c=this;a=a||{preload:"auto",autoplay:!1,loop:!1,muted:!1,controls:!1};var d=a.timeout||15e3;delete a.timeout;var e=b||function(){};for(var f in a){var g=a[f];c.logger.trace("HTMLAudioElement attribute:",f,g),c.$el[f]=g}var h="canplay",i=window.navigator.userAgent.match(/(iPhone\sOS)\s([\d_]+)/);return i&&0<i.length&&(h="suspend"),this.$el.addEventListener(h,function(a){return c.logger.trace("processEvent "+a.target.id+" : "+a.type,"event"),c.state.loaded=!0,c.$el.removeEventListener(h,a,!1),e(null,c)}),this.$el.addEventListener("ended",function(a){c._onEnded(a)},!1),setTimeout(function(){4!==c.$el.readyState&&(c.$el.src="",e(new Error("load of html audio file has timed out. timeout:"+d),c),e=function(){})},d),this.$el.load(),this},c.prototype.isUse=function(){return this.state.power===g.POWER_OFF||g.state.power===g.POWER_OFF?!1:this.state.loaded?"undefined"!=typeof this.state.error?!1:!0:!1},c.prototype.isPlayback=function(){return!!this.state.time.playback},c.prototype.isStop=function(){return!this.state.time.playback},c.prototype.isPause=function(){return!!this.state.time.pause},c.prototype.isLoop=function(){return 0<this.state.loop},c.prototype.play=function(a){return this.isUse()?this.isPlayback()?this:(a&&this.state.time.pause?(this.setCurrentTime(this.state.time.pause),this.state.time.pause=void 0,this.state.time.playback=Date.now(),this.$el.play()):(this.setCurrentTime(0),this.state.time.playback=Date.now(),this.$el.play()),this):this},c.prototype.stop=function(){return this.isUse()?(this.$el.pause(),this.setCurrentTime(0),this.state.time.playback=void 0,this):this},c.prototype.pause=function(){return this.isUse()?(this.$el.pause(),this.state.time.pause=this.$el.currentTime,this.state.time.playback=void 0,this):this},c.prototype.resume=function(){return this.isUse()?(this.state.time.pause&&this.play(!0),this):this},c.prototype.replay=function(){return this.isUse()?(this.pause(),this.setCurrentTime(0),this.play(),this):this},c.prototype.volume=function(a){this.logger.trace("set volume:",a),this.$el.volume=a},c.prototype._onEnded=function(a){this.logger.trace("onended fire! name:",this.name),this.state.time.playback=void 0,this.state.loop===g.LOOP_ORIGINAL&&"undefined"==typeof this.state.time.pause?(this.logger.trace("onended loop play. name:",this.name),this.state.time.progresss=0,this.play()):this.onEnded(a)},c.prototype.onEnded=b,c.prototype.setLoop=function(a){return this.isUse()?(this.state.loop=a,a===g.LOOP_NOT?this.$el.loop=g.LOOP_NOT:a===g.LOOP_ORIGINAL||a===g.LOOP_NATIVE&&this.$el&&(this.$el.loop=a),this):this},c.prototype.power=function(a){return a===g.POWER_OFF&&this.stop(),this.state.power=a,this},c.prototype.setCurrentTime=function(a){try{this.$el.currentTime=a}catch(b){this.logger.error("Set currentTime.",b.message)}return this},c.prototype.dispose=function(){delete this.name,delete this.state.time.playback,delete this.state.time.pause,delete this.state.time,delete this.state.loop,delete this.state.power,delete this.state.loaded,delete this.state.error,delete this.state,this.$el.src=void 0,delete this.$el},c}(),i=function(){function a(a){this.logger=new e("HTMLVideo"),this.name=a,this.state={time:{playback:void 0,pause:void 0},loop:g.LOOP_NOT,power:g.POWER_ON,loaded:!1,error:void 0},this.$el=document.createElement("video")}return a.prototype.load=function(a,b){var c=this;a=a||{preload:"auto",autoplay:!1,loop:!1,muted:!1,controls:!1};var d=a.timeout||15e3;delete a.timeout;var e=b||function(){};for(var f in a){var g=a[f];c.logger.trace("HTMLVideoElement attribute:",f,g),c.$el[f]=g}var h="canplay",i=window.navigator.userAgent.match(/(iPhone\sOS)\s([\d_]+)/);return i&&0<i.length?h="suspend":window.navigator.userAgent.match(/(Android)\s+(4)([\d.]+)/)?h="loadeddata":window.navigator.userAgent.match(/(Android)\s+(2)([\d.]+)/)&&(h="stalled"),this.$el.addEventListener(h,function(a){return c.logger.trace("processEvent "+a.target.id+" : "+a.type,"event"),c.state.loaded=!0,c.$el.removeEventListener(h,a,!1),e(null,c)}),this.$el.addEventListener("ended",function(a){c._onEnded(a)},!1),setTimeout(function(){c.$el&&4!==c.$el.readyState&&(c.$el.src="",e(new Error("load of html video file has timed out. timeout:"+d),c),e=function(){})},d),this.$el.load(),this},a.prototype.isUse=function(){return this.state.power===g.POWER_OFF||g.state.power===g.POWER_OFF?!1:this.state.loaded?"undefined"!=typeof this.state.error?!1:!0:!1},a.prototype.isPlayback=function(){return!!this.state.time.playback},a.prototype.isStop=function(){return!this.state.time.playback},a.prototype.isPause=function(){return!!this.state.time.pause},a.prototype.isLoop=function(){return 0<this.state.loop},a.prototype.play=function(a){return this.isUse()?this.isPlayback()?this:(a&&this.state.time.pause?(this.setCurrentTime(this.state.time.pause),this.state.time.pause=void 0,this.state.time.playback=Date.now(),this.$el.play()):(this.setCurrentTime(0),this.state.time.playback=Date.now(),this.$el.play()),this):this},a.prototype.stop=function(){return this.isUse()?(this.$el.pause(),this.setCurrentTime(0),this.state.time.playback=void 0,this):this},a.prototype.pause=function(){return this.isUse()?(this.$el.pause(),this.state.time.pause=this.$el.currentTime,this.state.time.playback=void 0,this):this},a.prototype.resume=function(){return this.isUse()?(this.state.time.pause&&this.play(!0),this):this},a.prototype.replay=function(){return this.isUse()?(this.pause(),this.setCurrentTime(0),this.play(),this):this},a.prototype.volume=function(a){this.logger.trace("set volume:",a),this.$el.volume=a},a.prototype._onEnded=function(a){this.logger.trace("onended fire! name:",this.name),this.state.time.playback=void 0,this.state.loop===g.LOOP_ORIGINAL&&"undefined"==typeof this.state.time.pause?(this.logger.trace("onended loop play. name:",this.name),this.play()):this.onEnded(a)},a.prototype.onEnded=b,a.prototype.setLoop=function(a){return this.isUse()?(this.state.loop=a,a===g.LOOP_NOT?this.$el.loop=g.LOOP_NOT:a===g.LOOP_ORIGINAL||a===g.LOOP_NATIVE&&this.$el&&(this.$el.loop=a),this):this},a.prototype.power=function(a){return a===g.POWER_OFF&&this.stop(),this.state.power=a,this},a.prototype.setCurrentTime=function(a){try{this.$el.currentTime=a}catch(b){this.logger.error("Set currentTime.",b.message)}return this},a.prototype.dispose=function(){delete this.name,delete this.state.time.playback,delete this.state.time.pause,delete this.state.time,delete this.state.loop,delete this.state.power,delete this.state.loaded,delete this.state.error,delete this.state,this.$el.src=void 0,delete this.$el},a}(),j=function(){function a(a){this.logger=new e("WebAudio "),this.buffer=void 0,this.source=void 0,this.state={time:{playback:void 0,pause:void 0,progress:0},loop:g.LOOP_NOT,power:g.POWER_ON,loaded:!1,error:void 0},this.name=a,this.ctx=g.WEB_AUDIO_CONTEXT,this.gainNode=this.ctx.createGain()}return a.prototype.load=function(a,b){var c=this;a=a||{};var d=b||function(){},e=new XMLHttpRequest;e.onload=function(b){return"2"!==b.target.status.toString().charAt(0)?(c.logger.error("fail to load resource: ",a.url),d(new Error("fail to load resource"),c)):void c.ctx.decodeAudioData(e.response,function(b){return b?(c.buffer=b,c.state.loaded=!0,d(null,c)):(c.logger.error("error decode file data: ",a.url),d(new Error("error decode file data"),c))},function(){return d(new Error("fail to decode file data"),c)})};var f=a.timeout||15e3;return setTimeout(function(){4!==e.readyState&&(e.abort(),d(new Error("load of web audio file has timed out. timeout:"+f),c),d=function(){})},f),e.open("GET",a.src,!0),e.responseType="arraybuffer",e.send(),this},a.prototype.isUse=function(){return this.state.power===g.POWER_OFF||g.state.power===g.POWER_OFF?!1:this.state.loaded?"undefined"!=typeof this.state.error?!1:!0:!1},a.prototype.isPlayback=function(){return!(!this.source||!this.state.time.playback||this.state.time.pause||1!==this.source.playbackState&&2!==this.source.playbackState)},a.prototype.isStop=function(){return!this.source},a.prototype.isPause=function(){return!!this.state.time.pause},a.prototype.isLoop=function(){return 0<this.state.loop},a.prototype.play=function(a){var b=this;if(!this.isUse())return this;if(this.isPlayback())return this;if(a||this.sourceDispose(),this.source=this.ctx.createBufferSource(),this.source.onended=function(a){b._onEnded(a)},this.state.loop===g.LOOP_NATIVE&&(this.source.loop=this.state.loop),this.source.buffer=this.buffer,this.source.connect(this.gainNode),this.gainNode.connect(this.ctx.destination),this.state.time.playback=Date.now(),a&&this.state.time.pause){var c=this.state.time.pause/1e3;this.logger.trace("offset:",c),this.source.start?this.source.start(0,c):this.source.noteOn(c),this.state.time.pause=void 0}else this.source.start?this.source.start(0):this.source.noteOn(0);return this},a.prototype.stop=function(){return this.isUse()?(this.source&&(this.source.stop?this.source.stop(0):this.source.noteOff(0)),this.sourceDispose(),this):this},a.prototype.pause=function(){if(!this.isUse())return this;if(!this.source)return this.logger.warn("Skip pause, Not playing."),this;if(this.state.time.pause)return this.logger.warn("Skip pause, It is already paused."),this;var a=Date.now(),b=a-this.state.time.playback;return this.state.time.pause=this.state.time.progress+b,this.state.time.progress+=b,this.logger.trace("state.time.pause:",this.state.time.pause,"now:",a,"state.time.playback",this.state.time.playback),this.source.noteOff(0),this},a.prototype.resume=function(){return this.isUse()?(this.state.time.pause&&this.play(!0),this):this},a.prototype.replay=function(){return this.isUse()?(this.sourceDispose(),this.play(),this):this},a.prototype.volume=function(a){this.logger.trace("change volume name:",this.name,"volume:",a),this.gainNode.gain.value=a},a.prototype._onEnded=function(a){var b=Date.now();this.source&&Math.abs((b-this.state.time.playback+this.state.time.progress)/1e3-this.source.buffer.duration)>=.01||(this.logger.trace("onended fire!",this.state.time),this.state.time.playback=void 0,this.state.loop&&"undefined"==typeof this.state.time.pause?(this.logger.trace("onended loop play."),this.play()):(this.sourceDispose(),this.onEnded(a)))},a.prototype.onEnded=b,a.prototype.setLoop=function(a){return this.isUse()?(this.state.loop=a,a===g.LOOP_NOT?this.source&&(this.source.loop=g.LOOP_NOT):a===g.LOOP_ORIGINAL||a===g.LOOP_NATIVE&&this.source&&(this.source.loop=a),this):this},a.prototype.power=function(a){return a===g.POWER_OFF&&this.stop(),this.state.power=a,this},a.prototype.sourceDispose=function(){this.logger.trace("WebAudio source dispose",this.name),this.source&&this.source.disconnect(),this.source=void 0,this.state.time.playback=void 0,this.state.time.pause=void 0,this.state.time.progress=0},a.prototype.dispose=function(){this.logger.trace("WebAudio dispose",this.name),delete this.buffer,this.sourceDispose(),delete this.state.time,delete this.state.loop,delete this.state.power,delete this.state.loaded,delete this.state.error,delete this.state,delete this.name,this.gainNode&&this.gainNode.disconnect&&delete this.gainNode,this.ctx=null},a}();g.HTMLAudio=h,g.HTMLVideo=i,g.WebAudio=j,c?define([],function(){return g}):a.boombox=g}(window);
//# sourceMappingURL=boombox.min.map